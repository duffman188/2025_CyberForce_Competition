<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>SOC Dashboard</title>
  <style>
    :root { --bg:#0f1216; --fg:#e5e7eb; --muted:#9aa4b2; --up:#39d353; --down:#ff5c5c; --warn:#f1c40f; --deg:#ffa500; --card:#11161d; --table:#0b0f14; --border:#1f2937; --mono: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; }
    * { box-sizing: border-box; }
    body { margin:0; background:var(--bg); color:var(--fg); font: 15px/1.45 system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji","Segoe UI Emoji"; }
    header { padding:16px 20px; display:flex; gap:16px; align-items:baseline; border-bottom:1px solid var(--border); }
    h1 { margin:0; font-size:22px; }
    .subtle { color:var(--muted); font-size:12px; }
    main { padding:16px 20px; max-width:1100px; margin:0 auto; }
    .cards { display:grid; grid-template-columns: repeat(4, minmax(0,1fr)); gap:12px; }
    .card { background:var(--card); border:1px solid var(--border); padding:12px; border-radius:10px; }
    .card-title { color:var(--muted); font-size:12px; margin-bottom:6px; }
    .big-num { font-size:28px; font-weight:700; }
    .mono { font-family: var(--mono); }
    .panel { margin-top:16px; background:var(--card); border:1px solid var(--border); border-radius:10px; overflow:hidden; }
    .panel-header { padding:12px 12px; border-bottom:1px solid var(--border); display:flex; align-items:center; justify-content:space-between; }
    table { width:100%; border-collapse: collapse; background:var(--table); }
    thead th { text-align:left; font-weight:600; color:var(--muted); font-size:12px; padding:8px 10px; border-bottom:1px solid var(--border); }
    tbody td { padding:8px 10px; border-bottom:1px solid var(--border); }
    .UP { color:var(--up); font-weight:700; }
    .DOWN { color:var(--down); font-weight:700; }
    .Warning, .Flapping { color:var(--warn); font-weight:700; }
    .Degraded, .DEGRADED { color:var(--deg); font-weight:700; }
    .actions { display:flex; gap:8px; align-items:center; }
    button { background:#1f2937; color:#fff; border:1px solid var(--border); padding:8px 10px; border-radius:8px; cursor:pointer; }
    button:hover { filter:brightness(1.1); }
    code { background:#11161d; border:1px solid var(--border); padding:2px 5px; border-radius:6px; }
    footer { color:var(--muted); font-size:12px; padding:12px 0 0 0; }
    @media (max-width: 880px) { .cards { grid-template-columns: repeat(2,minmax(0,1fr)); } }
  </style>
</head>
<body>
  <header>
    <h1>SOC Dashboard</h1>
    <div class="subtle">Endpoints: <code>/api/services</code>, <code>/api/alerts</code>, <code>/api/run</code>, <code>/api/stream</code></div>
  </header>

  <main>
    <section class="cards">
      <div class="card"><div class="card-title">Services</div><div class="big-num" id="svcCount">0</div></div>
      <div class="card"><div class="card-title">Alerts</div><div class="big-num" id="alertCount">0</div></div>
      <div class="card"><div class="card-title">Last Update</div><div class="mono" id="lastUpdate">-</div></div>
      <div class="card actions">
        <button id="refreshBtn">Run checks</button>
        <label><input type="checkbox" id="autoChk" checked/> Auto-refresh (10s fallback)</label>
      </div>
    </section>

    <section class="panel">
      <div class="panel-header"><h3>Monitored Services</h3></div>
      <table>
        <thead><tr>
          <th>Status</th><th>Name</th><th>Host</th><th>Port</th><th>Latency</th>
        </tr></thead>
        <tbody id="servicesTbody"></tbody>
      </table>
    </section>

    <section class="panel" style="margin-top:16px;">
      <div class="panel-header"><h3>Recent Alerts</h3></div>
      <table>
        <thead><tr>
          <th>Time (UTC)</th><th>Service</th><th>Host</th><th>Port</th><th>Status</th>
        </tr></thead>
        <tbody id="alertsTbody"></tbody>
      </table>
    </section>

    <footer>© CyberForce 2025</footer>
  </main>

  <script>
    // ===== Last-known-good caches to prevent flicker to 0 =====
    let lastServices = [];
    let lastAlerts = [];

    // ===== DOM helpers =====
    const $ = (id) => document.getElementById(id);
    const setLastUpdate = () => { const el = $("lastUpdate"); if (el) el.textContent = new Date().toISOString(); };

    function asServices(payload) {
      if (!payload) return [];
      // API returns {services: [...]}
      if (Array.isArray(payload.services)) return payload.services;
      if (Array.isArray(payload)) return payload;
      return [];
    }

    function asAlerts(payload) {
      if (!payload) return [];
      if (Array.isArray(payload.alerts)) return payload.alerts;
      if (Array.isArray(payload)) return payload;
      return [];
    }

    function updateServices(servicesMaybe) {
      const services = (Array.isArray(servicesMaybe) && servicesMaybe.length) ? servicesMaybe : lastServices;
      if (Array.isArray(servicesMaybe) && servicesMaybe.length) lastServices = servicesMaybe;

      const tbody = $("servicesTbody"); if (!tbody) return;
      tbody.innerHTML = "";
      for (const s of services) {
        const status = (s.status || (s.up ? "UP" : "DOWN")).toUpperCase();
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td class="${status}">${status}</td>
          <td>${s.name ?? "-"}</td>
          <td class="mono">${s.host ?? "-"}</td>
          <td class="mono">${s.port ?? "-"}</td>
          <td class="mono">${s.latency_ms ?? "-"}</td>`;
        tbody.appendChild(tr);
      }
      const svcCount = $("svcCount"); if (svcCount) svcCount.textContent = String(services.length);
    }

    function updateAlerts(alertsMaybe) {
      const alerts = (Array.isArray(alertsMaybe) && alertsMaybe.length) ? alertsMaybe : lastAlerts;
      if (Array.isArray(alertsMaybe) && alertsMaybe.length) lastAlerts = alertsMaybe;

      const tbody = $("alertsTbody"); if (!tbody) return;
      tbody.innerHTML = "";
      for (const a of alerts) {
        const status = String(a.status || "-").toUpperCase();
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td class="mono">${a.time ?? "-"}</td>
          <td>${a.service ?? "-"}</td>
          <td class="mono">${a.host ?? "-"}</td>
          <td class="mono">${a.port ?? "-"}</td>
          <td class="${status}">${status}</td>`;
        tbody.appendChild(tr);
      }
      const alertCount = $("alertCount"); if (alertCount) alertCount.textContent = String(alerts.length);
    }

    // ===== SSE (live) + Fallback poller =====
    let es;
    function startSSE() {
      try {
        es = new EventSource("/api/stream");
        es.onmessage = (ev) => {
          const raw = (ev.data || "").trim();
          if (!raw || raw === "{}") return; // ignore heartbeat
          try {
            const data = JSON.parse(raw);
            const services = asServices(data.services ?? data);
            const alerts   = asAlerts(data.alerts ?? []);
            updateServices(services.length ? services : null);
            updateAlerts(alerts.length ? alerts : null);
            setLastUpdate();
          } catch {}
        };
        es.onerror = () => { try { es.close(); } catch {} setTimeout(startSSE, 3000); };
      } catch {
        // no SSE — fallback poll will still run
      }
    }

    async function pollOnce() {
      try {
        const [svcRes, alertRes] = await Promise.allSettled([
          fetch("/api/services").then(r => r.ok ? r.json() : Promise.reject()),
          fetch("/api/alerts").then(r => r.ok ? r.json() : Promise.reject()),
        ]);
        const services = (svcRes.status === "fulfilled") ? asServices(svcRes.value) : null;
        const alertsRaw = (alertRes.status === "fulfilled") ? asAlerts(alertRes.value) : null;
        const alerts = (Array.isArray(alertsRaw) && alertsRaw.length) ? alertsRaw : null;
        updateServices(services);
        updateAlerts(alerts);
        setLastUpdate();
      } catch { /* keep last-known-good */ }
    }

    function startPoller() {
      pollOnce();
      setInterval(() => {
        if ($("autoChk")?.checked) pollOnce();
      }, 10_000);
    }

    $("refreshBtn").onclick = async () => {
      try { await fetch("/api/run", { method: "POST" }); } catch {}
      pollOnce();
    };

    // Initial load
    (async function init() {
      setLastUpdate();
      startSSE();
      startPoller();
      // Prime UI with initial data to avoid empty first paint
      pollOnce();
    })();
  </script>
</body>
</html>

