<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>SOC Dashboard</title>
  <style>
    :root {
      --bg:#0f1117; --panel:#141824; --text:#e6e6e6; --muted:#9aa0aa;
      --up:#2ecc71; --down:#ff5c5c; --warn:#f5a623; --mono:#c9d1d9;
      --card:#1a2030; --table:#0d1220; --border:#252a38;
      --accent:#6ea8fe;
    }
    html, body { background:var(--bg); color:var(--text); margin:0; font:14px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial, "Apple Color Emoji", "Segoe UI Emoji"; }
    header { padding:16px 20px; border-bottom:1px solid var(--border); display:flex; justify-content:space-between; align-items:center; }
    header h1 { margin:0; font-size:20px; }
    header .subtle { color:var(--muted); font-size:12px; }
    main { padding:18px; max-width:1200px; margin:0 auto; }
    .cards { display:grid; grid-template-columns: repeat(4, 1fr); gap:12px; margin-bottom:16px; }
    .card { background:var(--card); border:1px solid var(--border); border-radius:12px; padding:14px; }
    .card .card-title { color:var(--muted); font-size:12px; margin-bottom:8px; }
    .big { font-size:28px; font-weight:700; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; color:var(--mono); }
    .actions { display:flex; align-items:center; gap:10px; }
    button { background:var(--accent); color:#081018; border:none; padding:8px 12px; border-radius:8px; cursor:pointer; font-weight:600; }
    button:active { transform: translateY(1px); }
    .panel { background:var(--panel); border:1px solid var(--border); border-radius:12px; margin-top:14px; overflow:hidden; }
    .panel-header { padding:12px 14px; border-bottom:1px solid var(--border); display:flex; justify-content:space-between; align-items:center; }
    table { width:100%; border-collapse:collapse; background:var(--table); }
    th, td { padding:10px 12px; border-bottom:1px solid var(--border); }
    th { text-align:left; color:var(--muted); font-weight:600; font-size:12px; }
    tr:hover td { background:#11162a; }
    .status-up { color:var(--up); font-weight:700; }
    .status-down { color:var(--down); font-weight:700; }
    .status-warn { color:var(--warn); font-weight:700; }
    footer { color:var(--muted); font-size:12px; padding:14px 0 0; text-align:center; }
    @media (max-width:900px){ .cards{ grid-template-columns: repeat(2,1fr);} }
    @media (max-width:600px){ .cards{ grid-template-columns: 1fr;} th:nth-child(3), td:nth-child(3), th:nth-child(4), td:nth-child(4){ display:none;} }
  </style>
</head>
<body>
  <header>
    <div>
      <h1>SOC Dashboard</h1>
      <div class="subtle">Endpoints: <code>/api/services</code>, <code>/api/alerts</code>, <code>/api/run</code>, <code>/api/stream</code></div>
    </div>
  </header>

  <main>
    <section class="cards">
      <div class="card">
        <div class="card-title">Services</div>
        <div class="big" id="serviceCount">0</div>
      </div>
      <div class="card">
        <div class="card-title">Alerts</div>
        <div class="big" id="alertCount">0</div>
      </div>
      <div class="card">
        <div class="card-title">Last Update</div>
        <div class="mono" id="lastUpdate">-</div>
      </div>
      <div class="card actions">
        <button id="runChecks">Run Checks Now</button>
        <span class="subtle">SSE live &nbsp;•&nbsp; 10s fallback</span>
      </div>
    </section>

    <section class="panel">
      <div class="panel-header">
        <h3>Monitored Services</h3>
      </div>
      <table id="servicesTable">
        <thead>
          <tr>
            <th>Status</th><th>Name</th><th>Host</th><th>Port</th><th>Latency</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>

    <section class="panel">
      <div class="panel-header">
        <h3>Recent Alerts</h3>
      </div>
      <table id="alertsTable">
        <thead>
          <tr>
            <th>Time (UTC)</th><th>Service</th><th>Host</th><th>Port</th><th>Status</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>

    <footer>© CyberForce 2025</footer>
  </main>

  <script>
    // ---- cache last-good so brief empty responses don't wipe UI ----
    let lastServices = [];
    let lastAlerts = [];
    let pollingTimer = null;

    function statusClass(s) {
      const t = (s || "").toUpperCase();
      if (t === "UP") return "status-up";
      if (t === "DEGRADED" || t === "FLAPPING" || t === "WARNING") return "status-warn";
      return "status-down";
    }
    function asServices(payload) {
      if (Array.isArray(payload)) return payload;
      if (payload && Array.isArray(payload.services)) return payload.services;
      return [];
    }
    function asAlerts(payload) {
      if (Array.isArray(payload)) return payload;
      if (payload && Array.isArray(payload.alerts)) return payload.alerts;
      return [];
    }
    function setLastUpdate() {
      document.getElementById("lastUpdate").textContent = new Date().toISOString();
    }
    function updateServices(services) {
      const tbody = document.querySelector("#servicesTable tbody");
      tbody.innerHTML = "";
      services.forEach(s => {
        const st = s.status || (s.up ? "UP" : "DOWN") || "UNKNOWN";
        const lat = (s.latency_ms != null) ? `${s.latency_ms} ms` : "-";
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td class="${statusClass(st)}">${st}</td>
          <td>${s.name ?? "-"}</td>
          <td class="mono">${s.host ?? "-"}</td>
          <td class="mono">${s.port ?? "-"}</td>
          <td class="mono">${lat}</td>
        `;
        tbody.appendChild(tr);
      });
      document.getElementById("serviceCount").textContent = services.length;
    }
    function updateAlerts(alerts) {
      const tbody = document.querySelector("#alertsTable tbody");
      tbody.innerHTML = "";
      alerts.slice(-50).reverse().forEach(a => {
        const st = a.status ?? a.change ?? "-";
        const when = a.time ?? a.timestamp ?? "-";
        const name = a.service ?? a.name ?? "-";
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td class="mono">${when}</td>
          <td>${name}</td>
          <td class="mono">${a.host ?? "-"}</td>
          <td class="mono">${a.port ?? "-"}</td>
          <td class="${statusClass(st)}">${st}</td>
        `;
        tbody.appendChild(tr);
      });
      document.getElementById("alertCount").textContent = alerts.length;
    }
    function safeRender(servicesMaybe, alertsMaybe) {
      const services = (Array.isArray(servicesMaybe) && servicesMaybe.length) ? servicesMaybe : lastServices;
      const alerts   = (Array.isArray(alertsMaybe)) ? alertsMaybe : lastAlerts;

      if (Array.isArray(servicesMaybe) && servicesMaybe.length) lastServices = servicesMaybe;
      if (Array.isArray(alertsMaybe)) lastAlerts = alertsMaybe;

      updateServices(services);
      updateAlerts(alerts);
      setLastUpdate();
    }
    async function fetchData() {
      try {
        const [svcRes, alertRes] = await Promise.allSettled([
          fetch("/api/services").then(r => r.ok ? r.json() : Promise.reject()),
          fetch("/api/alerts").then(r => r.ok ? r.json() : Promise.reject()),
        ]);
        const services = svcRes.status === "fulfilled" ? asServices(svcRes.value) : null;
        const alerts   = alertRes.status === "fulfilled" ? asAlerts(alertRes.value) : null;
        safeRender(services, alerts);
      } catch {
        safeRender(null, null); // keep last-good
      }
    }
    document.getElementById("runChecks").addEventListener("click", async () => {
      try { await fetch("/api/run", { method: "POST" }); } catch {}
      await fetchData();
    });

    (function initStream(){
      if (!window.EventSource) {
        if (!pollingTimer) pollingTimer = setInterval(fetchData, 10000);
        fetchData();
        return;
      }
      const es = new EventSource("/api/stream");
      es.onmessage = (ev) => {
        const raw = (ev.data || "").trim();
        if (!raw || raw === "{}") return;  // ignore empties/keepalive
        try {
          const data = JSON.parse(raw);
          const services = asServices(data.services ?? data);
          const alerts = asAlerts(data.alerts ?? []);
          safeRender(services, alerts);
        } catch {
          /* ignore parse errors */
        }
      };
      es.onerror = () => {
        try { es.close(); } catch {}
        if (!pollingTimer) pollingTimer = setInterval(fetchData, 10000);
        fetchData();
      };
    })();

    // initial paint
    fetchData();
  </script>
</body>
</html>

