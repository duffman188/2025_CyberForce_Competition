#!/usr/bin/env python3
import os, json, time, socket
from contextlib import closing
from flask import Flask, render_template_string, request, jsonify

# --- Configuration -----------------------------------------------------------
BASE      = os.path.dirname(os.path.abspath(__file__))
DATA      = os.path.join(BASE, "DATA")
SERVICES  = os.path.join(DATA, "SERVICES")
ALERTS    = os.path.join(DATA, "ALERTS")
os.makedirs(DATA, exist_ok=True)

# --- Helpers -----------------------------------------------------------------
def load(path, default):
    try:
        with open(path) as f:
            return json.load(f)
    except Exception:
        return default

def save(path, obj):
    tmp = path + ".tmp"
    with open(tmp, "w") as f:
        json.dump(obj, f, indent=2)
    os.replace(tmp, path)

def port_up(host, port, timeout=1.0):
    """Return True if TCP connect succeeds."""
    with closing(socket.socket(socket.AF_INET, socket.SOCK_STREAM)) as s:
        s.settimeout(timeout)
        try:
            s.connect((host, port))
            return True
        except Exception:
            return False

# --- Flask app ---------------------------------------------------------------
app = Flask(__name__)

# HTML template (simple table view)
TEMPLATE = """<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Team 42 — SOC Dashboard</title>
<style>
body { font-family: sans-serif; margin: 2em; background:#101010; color:#e0e0e0; }
table { border-collapse: collapse; width: 100%; margin-bottom: 2em; }
th, td { padding: .4em .8em; border: 1px solid #444; text-align:left; }
th { background:#222; }
.up { color: #00ff99; font-weight:bold; }
.down { color: #ff5555; font-weight:bold; }
button { padding: .3em .8em; margin-bottom: 1em; }
</style>
</head>
<body>
<h1>Team 42 — SOC Dashboard</h1>
<p>Host: {{ host }} | Updated: {{ updated }}</p>
<form method="post" action="/check"><button>Re-check Services</button></form>

<h2>Service Uptime</h2>
<table>
<tr><th>Service</th><th>Host</th><th>Port</th><th>Status</th></tr>
{% for s in services %}
<tr>
<td>{{s.name}}</td>
<td>{{s.host}}</td>
<td>{{s.port}}</td>
<td class="{{'up' if s.up else 'down'}}">{{'UP' if s.up else 'DOWN'}}</td>
</tr>
{% endfor %}
</table>

<h2>Alerts</h2>
{% if alerts %}
<ul>
{% for a in alerts|reverse %}
<li>{{a.ts}} — {{a.summary}}</li>
{% endfor %}
</ul>
{% else %}
<p>No alerts yet</p>
{% endif %}
</body></html>
"""

# --- Routes ------------------------------------------------------------------
@app.get("/")
def index():
    services = load(SERVICES, [])
    alerts   = load(ALERTS, [])
    updated  = time.strftime("%Y-%m-%d %H:%M:%S")
    host     = socket.gethostname()
    return render_template_string(TEMPLATE, services=services, alerts=alerts,
                                  updated=updated, host=host)

@app.post("/ingest")
def ingest():
    data = request.form.get("summary", "")
    try:
        alert = json.loads(data)
    except Exception:
        alert = {"summary": data}
    alert["ts"] = time.strftime("%Y-%m-%d %H:%M:%S")
    alerts = load(ALERTS, [])
    alerts.append(alert)
    save(ALERTS, alerts)
    return "ok"

@app.post("/check")
def check():
    services = load(SERVICES, [])
    for s in services:
        s["up"] = port_up(s["host"], s["port"])
    save(SERVICES, services)
    return jsonify({"status": "checked", "count": len(services)})

# --- Initialization ----------------------------------------------------------
if __name__ == "__main__":
    # seed default files if missing
    if not os.path.exists(SERVICES):
        seed = [
            {"name":"Web (WinSrv)","host":"10.0.153.140","port":80,"up":False},
            {"name":"HTTPS (WinSrv)","host":"10.0.153.140","port":443,"up":False},
            {"name":"MariaDB (WinSrv)","host":"10.0.153.140","port":3306,"up":False},
            {"name":"RDP (WinSrv)","host":"10.0.153.140","port":3389,"up":False},
            {"name":"DNS (Infra)","host":"10.0.153.142","port":53,"up":False},
            {"name":"MySQL (Infra)","host":"10.0.153.142","port":3306,"up":False},
            {"name":"RDP (Infra)","host":"10.0.153.142","port":3389,"up":False},
            {"name":"SSH (Linux)","host":"10.0.153.145","port":22,"up":False},
            {"name":"nginx (Linux)","host":"10.0.153.145","port":80,"up":False},
            {"name":"Zeek Sensor","host":"10.0.153.181","port":22,"up":False},
            {"name":"Suricata Sensor","host":"10.0.153.188","port":22,"up":False},
            {"name":"Syslog Collector","host":"10.0.153.129","port":514,"up":False},
            {"name":"SNMP Monitor","host":"10.0.153.129","port":161,"up":False},
            {"name":"NTP Server","host":"10.0.153.129","port":123,"up":False}
        ]
        save(SERVICES, seed)
        print(f"Seeded {len(seed)} services -> {SERVICES}")
    if not os.path.exists(ALERTS):
        save(ALERTS, [])
    print("SOC Dashboard running on 0.0.0.0:5000")
    app.run(host="0.0.0.0", port=5000)

